<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Merci pour votre achat ‚Äì Calculateur ROI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#0b1220;
      color:#eaf0ff;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      text-align:center;
      padding:20px;
    }
    .box{
      max-width:560px;
      background:#0f1b33;
      padding:34px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,10);
    }
    h1{margin:0 0 10px; font-size:28px}
    p{color:#a9b6d6; margin:10px 0}
    .ok{
      display:inline-block;
      margin:14px 0 6px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(34,197,94,12);
      border:1px solid rgba(34,197,94,25);
      color:#d5ffe4;
      font-weight:800;
      font-size:12px;
    }
    .note{
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,255,255,04);
      border:1px solid rgba(255,255,255,10);
      color:#a9b6d6;
      font-size:13px;
      text-align:left;
    }
    .contact{
      margin-top:16px;
      font-size:14px;
      color:#a9b6d6;
    }
    .contact b{color:#eaf0ff}
    .btn{
      display:block;
      background:#22c55e;
      color:#022c22;
      padding:14px;
      border-radius:10px;
      font-weight:700;
      text-decoration:none;
      margin-bottom:18px;
    }
    .btn.disabled{
      opacity:.65;
      pointer-events:none;
      background:rgba(34,197,94,0.55);
      color:#eafff2;
    }
    .small{
      font-size:12px;
      color:#a9b6d6;
      opacity:.9;
      margin-top:-6px;
      margin-bottom:14px;
    }
  </style>
</head>

<body>
  <div class="box">
    <div class="ok">‚úÖ Paiement confirm√©</div>
    <h1>Merci pour votre achat üôè</h1>

    <p>
      Vous venez d‚Äôacqu√©rir le <b>Calculateur ROI Autopartage</b>.
    </p>

    <hr style="margin:25px 0; opacity:0.2">

    <!-- Bouton s√©curis√© (remplace le lien Drive public) -->
    <a id="downloadBtn" class="btn disabled" href="#">
      ‚è≥ Pr√©paration de votre lien s√©curis√©‚Ä¶
    </a>
    <div class="small" id="expiresTxt" style="display:none;">
      Lien personnel valable <b>24h</b>.
    </div>

    <div id="downloadHelp" class="note" style="display:none;">
      <b>Probl√®me ?</b><br>
      Nous n‚Äôavons pas pu g√©n√©rer le lien automatiquement.
      <br><br>
      ‚úÖ Solution : v√©rifiez votre email (nous vous avons aussi envoy√© un bouton de t√©l√©chargement).
    </div>

    <p>
      üì© Vous allez recevoir un email de confirmation (et votre lien s√©curis√©).
      Si vous ne le voyez pas, v√©rifiez vos spams.
    </p>

    <div class="note">
      <b>Prochaine √©tape :</b><br>
      1) Ouvrez le calculateur<br>
      2) Renseignez uniquement les <b>cellules en bleu</b><br>
      3) Choisissez votre mode de financement (cr√©dit / comptant / apport)<br>
      4) Analysez le <b>cash-flow mensuel</b>, le <b>ROI annuel</b> et le <b>d√©lai de retour</b>
      <br><br>
      üí° Conseil : utilisez des hypoth√®ses prudentes pour s√©curiser vos d√©cisions.
    </div>

    <div class="contact">
      Une question ? <b>support@rbm-location.com</b>
    </div>
  </div>

  <script>
    (async function () {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("session_id");

      const btn = document.getElementById("downloadBtn");
      const help = document.getElementById("downloadHelp");
      const expiresTxt = document.getElementById("expiresTxt");

      // Si Stripe n‚Äôa pas ajout√© session_id, on laisse l‚Äôutilisateur se baser sur l‚Äôemail
      if (!sessionId) {
        btn.classList.remove("disabled");
        btn.textContent = "üì© V√©rifier mon email pour le lien";
        btn.href = "mailto:";
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/create-download-link?session_id=" + encodeURIComponent(sessionId));
        if (!res.ok) throw new Error("bad response");

        const data = await res.json();
        if (!data.downloadUrl) throw new Error("missing downloadUrl");

        btn.classList.remove("disabled");
        btn.textContent = "üì• Acc√©der √† mes t√©l√©chargements";
        btn.href = data.downloadUrl;
        btn.target = "_blank";
        btn.rel = "noopener";

        expiresTxt.style.display = "block";
      } catch (e) {
        btn.classList.remove("disabled");
        btn.textContent = "üì© V√©rifier mon email pour le lien";
        btn.href = "mailto:";
        help.style.display = "block";
      }
    })();
  </script>
</body>
</html>
